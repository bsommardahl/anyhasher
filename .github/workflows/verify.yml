name: Verify
run-name: "ğŸ§ª CD: Verify Environment from ${{ github.event.inputs.ref }}"
on:
  workflow_dispatch:
    inputs:
      backend_url:
        required: true
      s3_bucket_hostname:
        required: true
      frontend_url:
        required: true
      ref:
        required: true

jobs:
  frontend:
    name: ğŸ§ª Check Frontend
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run Frontend Smoke Test
        run: |
          export TEST_URL=${{ github.event.inputs.frontend_url }}
          cd frontend/e2e
          npm install
          npm run smoke

  backend:
    name: ğŸ§ª Check Backend
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run Backend Smoke Test
        run: |
          export BACKEND_URL=${{ github.event.inputs.backend_url }}
          cd backend/e2e
          chmod +x backend-smoke.sh
          ./backend-smoke.sh

  trigger_cleanup:
    name: âŒ Cleanup Failing Environment
    if: ${{ failure() }}
    needs: [backend, frontend]
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Cleanup On Failure
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Cleanup
          inputs: '{ "ref": "${{ github.event.inputs.ref }}", "env_name": "Green Env after Verification Failure" }'

  trigger_promotion:
    name: ğŸ‘ Start Promotion of Verified Environment
    if: ${{ success() }}
    needs: [backend, frontend]
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Dispatch
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Promote
          inputs: '{ "ref": "${{ github.event.inputs.ref }}", "s3_bucket_hostname": "${{ github.event.inputs.s3_bucket_hostname }}" }'
